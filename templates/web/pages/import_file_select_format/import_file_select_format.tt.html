<!-- start templates/[% template.name %] -->
<script>
    console.log("started");
    function show_column_info(col) {

    $('.column_info_row').hide();
    $('#column_info_' + col).show();
    }

    function init_select_field_option(col) {

        // Based on the field, display the different field options and instructions

        var column = columns[col];

        var field = columns_fields[column]["field"];

        var instructions = "";

        $("#select_field_option_" + col).empty();

        if (field) {

            ["sources_fields", "categories", "labels"].forEach((tagtype) => {

                console.log(tagtype);

                var tagtype_specific = tagtype.concat("_specific");

                console.log(tagtype_specific);
                var str2 = "_s";
                var str3 = tagtype.concat(str2);
                var placeholder = [% lang("str3") %];
                var specific_tag = [% lang('tagtype.concat("_specific_tag")') %];
                var specific_tag_value = [% lang('tagtype.concat("_specific_tag_value")') %];

                //checking the value
               
                console.log(str3);
                console.log(lang("str3"));
                console.log(tagtype_specific);
                console.log(placeholder);
                console.log(specific_tag);


                if (field == "tagtype_specific") {

                    var input = '<input id="select_field_option_tag_' + col + '" name="select_field_option_tag_' + col + '" placeholder="placeholder" style="width:150px;margin-bottom:0;height:28px;">';

                    $("#select_field_option_" + col).html(input);

                    if (columns_fields[column]["tag"]) {
                        $('#select_field_option_tag_' + col).val(columns_fields[column]["tag"]);
                    }

                    $('#select_field_option_tag_' + col)
                    .on("change", function(e) {
                        var id = e.target.id;
                        var col = this.id.replace(/select_field_option_tag_/, '');
                        var column = columns[col];
                        columns_fields[column]["tag"] = $(this).val();
                    });

                    instructions += "<p>specific_tag</p>"
                    + "<p>specific_tag_value</p>";
                }

            },

            else if (field.match(/_value_unit/)) {

                var select = '<select id="select_field_option_value_unit_' + col + '" name="select_field_option_value_unit_' + col + '" style="width:150px">'
                + '<option></option>';

                if (field.match(/^energy/)) {
                    select += '<option value="value_in_kj">$Lang{value_in_kj}{$lc}</option>'
                    + '<option value="value_in_kcal">$Lang{value_in_kcal}{$lc}</option>';
                }
                else if (field.match(/weight/)) {
                    select += '<option value="value_in_g">$Lang{value_in_g}{$lc}</option>';
                }
                else if (field.match(/volume/)) {
                    select += '<option value="value_in_l">$Lang{value_in_l}{$lc}</option>'
                    + '<option value="value_in_dl">$Lang{value_in_dl}{$lc}</option>'
                    + '<option value="value_in_cl">$Lang{value_in_cl}{$lc}</option>'
                    + '<option value="value_in_ml">$Lang{value_in_ml}{$lc}</option>';
                }
                else if (field.match(/quantity/)) {
                    select += '<option value="value_in_g">$Lang{value_in_g}{$lc}</option>'
                    + '<option value="value_in_l">$Lang{value_in_l}{$lc}</option>'
                    + '<option value="value_in_dl">$Lang{value_in_dl}{$lc}</option>'
                    + '<option value="value_in_cl">$Lang{value_in_cl}{$lc}</option>'
                    + '<option value="value_in_ml">$Lang{value_in_ml}{$lc}</option>';
                }
                else {
                    select += '<option value="value_in_g">$Lang{value_in_g}{$lc}</option>'
                    + '<option value="value_in_mg">$Lang{value_in_mg}{$lc}</option>'
                    + '<option value="value_in_mcg">$Lang{value_in_mcg}{$lc}</option>'
                    + '<option value="value_in_iu">$Lang{value_in_iu}{$lc}</option>'
                    + '<option value="value_in_percent">$Lang{value_in_percent}{$lc}</option>';
                }

                select += '<option value="value_unit">$Lang{value_unit}{$lc}</option>'
                + '<option value="value">$Lang{value}{$lc}</option>'
                + '<option value="unit">$Lang{unit}{$lc}</option>'
                + '</select>';

                $("#select_field_option_" + col).html(select);

                if (columns_fields[column]["value_unit"]) {
                    $('#select_field_option_value_unit_' + col).val(columns_fields[column]["value_unit"]);
                }

                $('#select_field_option_value_unit_' + col).select2({
                    placeholder: "$Lang{specify}{$lc}"
                }).on("select2:select", function(e) {
                    var id = e.params.data.id;
                    var col = this.id.replace(/select_field_option_value_unit_/, '');
                    var column = columns[col];
                    columns_fields[column]["value_unit"] = $(this).val();
                }).on("select2:unselect", function(e) {
                });

                instructions += "<p>$Lang{value_unit_dropdown}{$lc}</p>"
                + "<ul>"
                + "<li>$Lang{value_unit_dropdown_value_specific_unit}{$lc}</li>"
                + "<li>$Lang{value_unit_dropdown_value_unit}{$lc}</li>"
                + "<li>$Lang{value_unit_dropdown_value}{$lc}</li>"
                + "<li>$Lang{value_unit_dropdown_unit}{$lc}</li>"
                + "</ul>";
            }
        }

    }

</script>

<style>
   .select2-container--default .select2-results > .select2-results__options {
        max-height: 400px
    }

    pre {
        max-width:16em;
        overflow-x:auto;
    }
</style>


<h1>[% lang("import_data_file_select_format_title") %]</h1>
<p>[% lang("import_data_file_select_format_description") %]</p>
<p>[% import_file_rows_columns %]</p>

<form id="select_format_form" action="/cgi/import_file_process.pl" method="POST" enctype="multipart/form-data">

    <input type="submit" class="button small" value="[% lang('import_data') %]">
    [% selected_columns_count %]

    <table id="select_fields">
        <tr>
            <th>[% lang("column_in_file") %]</th>
            <th colspan="2">[% field_on_site %]</th>
        </tr>

        [% FOREACH data_row IN table_data_rows %]                          
            <tr id="column_[% data_row.col %]" class="column_row">
                <td>[% data_row.column_without_tags %]</td>
                <td>
                    <select class="select2_field" name="select_field_[% data_row.col %]" id="select_field_[% data_row.col %]" style="width:420px">
                        <option></option>
                    </select>
                </td>
                <td id="select_field_option_[% data_row.col %]"></td>
            </tr>

            <tr id="column_info_[% data_row.col %]" class="column_info_row" style="display:none">
                <td>data_row.examples</td>
                <td colspan="2" id="column_instructions_[% data_row.col %]">data_row.instructions</td>
            </tr>
        [% END %]

    </table>

    <input type="hidden" name="columns_fields_json" id="columns_fields_json">
    <input type="hidden" name="file_id" id="file_id" value="[% file_id %]">
    <input type="submit" class="button small" value="[% lang('import_data') %]">
    [% selected_columns_count %]

</form>


<!-- end templates/[% template.name %] -->
